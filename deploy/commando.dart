import "dart:typed_data" as FC;import "dart:html" as MB;import "dart:math" as nB;class GC{const GC();}class HC{final  name;const HC(this.name);}class IC{const IC();} main(){var g=MB.query("#area");MB.window.setImmediate(new JC(g).start);}class JC extends oB{JC( g):super(g); start(){for(int h=0;h<100;h++ ){var g=new HB();g.position.x=5.0*h;g.position.y=5.0*h;g.movement.AB.x=.2*(h*2305829.0)%50;g.movement.AB.y=1.0*h;g.q=30.0;tB(g);}super.start();}var bB=0.0; KB( g){uB();DC(1000.0/(g-bB));bB=g;o.TB=0;super.KB(g);} uB(){for(t h in DB){var g=h as HB;if(g==null)continue;if(g.m.top<0||g.m.bottom>height)g.movement.AB.y*= -1;if(g.m.left<0||g.m.right>width)g.movement.AB.x*= -1;}}var yB=MB.query("#fps");var CB; DC( g){if(CB==null)CB=g;CB=g*0.05+CB*0.95;yB.text="${CB.round()} fps";}}class oB{var DB=[] ;var RB;var context;var canvas;var width;var height;var JB;oB(this.canvas){width=canvas.width;height=canvas.height;var g=canvas.parent.client;width=g.width;height=g.height;canvas.width=width;JB=new o(right:width,bottom:height);context=canvas.context2D;} start(){MB.window.animationFrame.then(wB);} wB( g){RB=g;MB.window.animationFrame.then(KB);} tB( h){DB.add(h);var g=h as l;if(g!=null)JB.insert(g);} KB( h){var n=(h-RB)/1000.0;RB=h;context.clearRect(0,0,width,height);context..lineWidth=0.5;JB.update();JB.WB();for(t g in DB)g.iB(n);for(t g in DB)g.ZB(context);for(t g in DB)g.hB();MB.window.animationFrame.then(KB);}}class o{static final  pB=6;static final  qB=4;static final  rB=4;static var NB=new List<List<o>>();static var OB=new List<l>();var top,left,bottom,right;var v=0,u=0;var EB,FB;var j=new List<l>();var nodes;var parent;static var IB=1;static var TB=0;o({this.top: 0,this.left: 0,this.bottom: 0,this.right: 0}); WB([ g]){var n;var h;var jB=0,kB=0;if(g==null)g=[] ;for(int GB=0;GB<j.length;GB++ ){n=j[GB];if(!n.LB)continue;for(int SB=GB+1;SB<j.length;SB++ ){h=j[SB];jB++ ;if(h.LB)dB(n,h);}for(l h in g){if(h.LB)dB(n,h);kB++ ;}}if(nodes!=null){var s=new List<l>(g.length+j.length);s.setRange(0,g.length,g);s.setRange(g.length,s.length,j);for(o EC in nodes)EC.WB(s);}var lB=right-left;var mB=bottom-top;var KC=1-4*(lB/2-40.0)*(mB/2-40.0)/(lB-40.0)/(mB-40.0);var LC=j.length.toDouble()/u.toDouble();TB+= kB+jB;} dB( g, h){g.PB(h);h.PB(g);} split(){EB=(right+left)/2;FB=(bottom+top)/2;if(NB.length==0){nodes=new List<o>();for(int g=0;g<4;g++ )nodes.add(new o());}else nodes=NB.removeLast();for(int g=0;g<4;g++ ){if(g<2){nodes[g]..top=top..bottom=FB;}else{nodes[g]..bottom=bottom..top=FB;}if(g%2==0){nodes[g]..left=left..right=EB;}else{nodes[g]..right=right..left=EB;}nodes[g]..parent=this..v=v+1..u=0;}fB();IB+= 4;} fB(){var h;for(int g=j.length-1;g>=0;g-- ){if((h=aB(j[g]))!=-1)nodes[h].insert(j.removeAt(g));}} insert( g){var n;u++ ;if(nodes!=null&&(n=aB(g))!=-1){nodes[n].insert(g);return;}j.add(g);if(j.length>pB&&v<rB&&nodes==null){split();var s=nodes.map((h)=>h.j.length).join(',');var GB=nodes.map((h)=>h.u).join(',');print("split lev:${v}, n:${j.length}, sn:${s} sncc:${s} cc:${u}");}} XB(){var n;if(v!=0)for(int g=j.length-1;g>=0;g-- ){if(j[g].m.top<top||j[g].m.bottom>bottom||j[g].m.left<left||j[g].m.right>right){OB.add(j.removeAt(g));eB();}}if(nodes!=null){for(o h in nodes)h.XB();fB();}} update(){XB();for(int g=OB.length-1;g>=0;g-- ){insert(OB.removeAt(g));}YB();} YB(){if(nodes!=null){if(u<qB){gB();print("node at level ${v} was unsplit, count:${j.length}");print("nodecount ${IB} avg:${100/IB},");}else for(o g in nodes)g.YB();}} gB(){if(nodes!=null){for(o g in nodes){j.addAll(g.gB());g.j.clear();}NB.add(nodes);nodes=null;IB-= 4;}return j;} aB( g){var h=0;if(g.m.top>FB){h=2;}else if(g.m.bottom>FB)return -1;if(g.m.left>EB){h++ ;}else if(g.m.right>EB)return -1;return h;} eB(){u-- ;if(parent!=null)parent.eB();}}class HB extends t implements l{var OC=1;var color="black";var movement;var m;var LB=true; get q=>OC;set q( g){OC=g;m..width=2*g..height=2*g;}var QB=false;HB(){movement=new sB();this.position=movement.position;m=new UB(q,q);m.BB=position;} ZB( g,[ h]){color=QB?"#ff0000":"#0000ff";g..fillStyle=color..strokeStyle=color..beginPath()..arc(position.x,position.y,q,0,nB.PI*2,false)..fill()..closePath();} PB( h){var g=h;var n=(g.position-this.position).cB;var s=nB.pow(this.q+g.q,2);if(g==null)return;if((g.position-this.position).cB<nB.pow(this.q+g.q,2))vB(g);} vB( g){QB=true;} hB(){QB=false;} iB( g){movement.update(g);}}abstract class t{var position=new k.MC(); ZB( h,[ g]); iB( g); hB();}class sB{var xB=1;var position=new k.MC();var AB=new k.MC();var force=new k.MC(); update( g){AB.add(force.scale(g/xB));position.add(AB.zB(g));force.CC();}}class UB{UB( g, h){this.width=g;this.height=h;} get top=>BB.y-PC; get left=>BB.x-QC; get bottom=>BB.y+PC; get right=>BB.x+QC;var RC; get width=>RC;set width( g){RC=g;QC=g/2;}var SC; get height=>RC;set height( g){SC=g;PC=g/2;}var PC;var QC;var BB; toString()=>"t:${top}, l:${left}, b:${bottom}, r:${right}";}abstract class l{ get LB; PB( g); get m; get position;}class k{final  i=new FC.Float32List(2);k( h, g){BC(h,g);}k.MC();k.NC( g){AC(g);} BC( h, g){i[0]=h;i[1]=g;return this;} CC(){i[0]=0.0;i[1]=0.0;return this;} AC( g){i[1]=g.i[1];i[0]=g.i[0];return this;} toString()=>'[${i[0]},${i[1]}]'; operator-()=>new k(-i[0],-i[1]); operator-( g)=>new k(i[0]-g.i[0],i[1]-g.i[1]); operator+( g)=>new k(i[0]+g.i[0],i[1]+g.i[1]); operator/( h){var g=1.0/h;return new k(i[0]*g,i[1]*g);} operator*( h){var g=h;return new k(i[0]*g,i[1]*g);} operator[]( g)=>i[g]; operator[]=( h, g){i[h]=g;} get length{var g;g=(i[0]*i[0]);g+= (i[1]*i[1]);return nB.sqrt(g);} get cB{var g;g=(i[0]*i[0]);g+= (i[1]*i[1]);return g;} add( g){i[0]=i[0]+g.i[0];i[1]=i[1]+g.i[1];return this;} scale( g){i[1]=i[1]*g;i[0]=i[0]*g;return this;} zB( g){return clone().scale(g);} clone(){return new k.NC(this);}set x( g)=>i[0]=g;set y( g)=>i[1]=g; get x=>i[0]; get y=>i[1];}class VB{}